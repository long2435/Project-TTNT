{% extends 'app/base.html' %}

{% block content %}
<div class="container py-5">
  <div class="row">
    <!-- Ảnh sản phẩm -->
    <div class="col-md-6 mb-4">
      {% if product.image %}
        <img src="{{ product.image.url }}" alt="{{ product.name }}" class="img-fluid rounded shadow-sm">
      {% else %}
        <img src="https://via.placeholder.com/400x400?text=No+Image" alt="No Image" class="img-fluid rounded shadow-sm">
      {% endif %}
    </div>

    <!-- Thông tin sản phẩm -->
    <div class="col-md-6">
      <h2 class="mb-3">{{ product.name }}</h2>
      {% if product.discount_price and product.discount_price < product.price %}
        <p class="mb-3">
          <del class="text-muted">{{ product.price|floatformat:0 }} VNĐ</del>
          <strong class="text-danger ms-2">{{ product.discount_price|floatformat:0 }} VNĐ</strong>
        </p>
      {% else %}
        <h4 class="text-danger mb-3"><strong>{{ product.price|floatformat:0 }} VNĐ</strong></h4>
      {% endif %}
      
      <p><strong>Mô tả sản phẩm:</strong></p>
      <p>{{ product.description|default:"Chưa có mô tả." }}</p>

      <!-- Nút thêm vào giỏ hàng + mua ngay -->
      <div class="d-flex gap-3 mt-4">
        <a href="{% url 'add_to_cart' product.id %}" class="btn btn-primary btn-lg">
          <i class="bi bi-cart-plus"></i> Thêm vào giỏ hàng
        </a>

        <form method="post" action="{% url 'add_to_cart_then_checkout' product.id %}">
          {% csrf_token %}
          <button type="submit" class="btn btn-success btn-lg">
            <i class="bi bi-lightning-charge"></i> Mua ngay
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Đánh giá sản phẩm -->
  <div class="mt-5">
    <h4>Đánh giá sản phẩm</h4>
    
    {% if reviews %}
      {% for review in reviews %}
        <div class="card my-3">
          <div class="card-body">
            <h6 class="card-title mb-1">{{ review.user.username }} 
              <span class="text-warning">
                {% for i in "12345" %}
                  {% if forloop.counter <= review.rating %}
                    ★
                  {% else %}
                    ☆
                  {% endif %}
                {% endfor %}
              </span>
            </h6>

            {% if request.user == review.user %}
              <form method="post" action="{% url 'edit_review' product.id review.id %}">
                {% csrf_token %}
                <div class="mb-2">
                  <label class="form-label">Số sao:</label>
                  <div class="star-rating">
                    {% for star in "54321" %}
                      <input type="radio" id="star-edit-{{ review.id }}-{{ star }}" name="rating" value="{{ star }}" 
                             {% if review.rating|stringformat:"s" == star %}checked{% endif %}/>
                      <label for="star-edit-{{ review.id }}-{{ star }}" title="{{ star }} sao">&#9733;</label>
                    {% endfor %}
                  </div>
                </div>

                <div class="mb-2">
                  <label class="form-label">Nhận xét:</label>
                  <textarea name="comment" class="form-control">{{ review.comment }}</textarea>
                </div>

                <div class="d-flex gap-2 mt-2">
                  <button type="submit" class="btn btn-sm btn-outline-primary">Cập nhật</button>
              </form>
                
                  <form method="post" action="{% url 'delete_review' product.id review.id %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-outline-danger"
                            onclick="return confirm('Bạn có chắc muốn xóa đánh giá này?');">
                      Xóa
                    </button>
                  </form>
                </div>
                
            {% else %}
              <p class="card-text">{{ review.comment }}</p>
            {% endif %}
            <small class="text-muted">{{ review.created_at|date:"d/m/Y H:i" }}</small>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <p>Chưa có đánh giá nào cho sản phẩm này.</p>
    {% endif %}
  </div>

  <!-- Form gửi đánh giá -->
  {% if user.is_authenticated %}
    <div class="mt-4">
      <h5>Gửi đánh giá của bạn</h5>
      <form method="post" action="{% url 'add_review' product.id %}">
        {% csrf_token %}
        {{ review_form.non_field_errors }}
        
        <!-- Star Rating -->
        <div class="mb-3">
          <label for="id_rating" class="form-label">Số sao (1-5):</label>
          <div class="star-rating">
            {% for star in "54321" %}
              <input type="radio" id="star-{{ star }}" name="rating" value="{{ star }}" {% if review_form.rating.value|stringformat:"s" == star %}checked{% endif %}/>
              <label for="star-{{ star }}" title="{{ star }} sao">&#9733;</label>
            {% endfor %}
          </div>
        </div>

        <div class="mb-3">
          <label for="id_comment" class="form-label">Nhận xét:</label>
          {{ review_form.comment }}
        </div>

        <button type="submit" class="btn btn-primary">Gửi đánh giá</button>
      </form>
    </div>
  {% else %}
    <p class="mt-3">Vui lòng <a href="{% url 'login' %}">đăng nhập</a> để gửi đánh giá.</p>
  {% endif %}

 <!-- Câu hỏi thường gặp (FAQ) -->
<div class="mt-5" id="faq">
  <h4>Câu hỏi thường gặp</h4>
  <div class="accordion" id="faqAccordion">
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingOne">
        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
          Câu hỏi 1: Sản phẩm có bảo hành không?
        </button>
      </h2>
      <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#faqAccordion">
        <div class="accordion-body">
          Vâng, sản phẩm này được bảo hành 12 tháng.
        </div>
      </div>
    </div>
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingTwo">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
          Câu hỏi 2: Sản phẩm có hỗ trợ trả góp không?
        </button>
      </h2>
      <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#faqAccordion">
        <div class="accordion-body">
          Có, bạn có thể trả góp qua các đối tác tài chính của chúng tôi.
        </div>
      </div>
    </div>
    <!-- Thêm câu hỏi 3 -->
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingThree">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
          Câu hỏi 3: Làm sao để liên hệ với bộ phận hỗ trợ khách hàng?
        </button>
      </h2>
      <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="#faqAccordion">
        <div class="accordion-body">
          Bạn có thể liên hệ qua số điện thoại hoặc email hỗ trợ trên website của chúng tôi. Chúng tôi luôn sẵn sàng hỗ trợ bạn!
        </div>
      </div>
    </div>
    <!-- Thêm câu hỏi 4 -->
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingFour">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFour" aria-expanded="false" aria-controls="collapseFour">
          Câu hỏi 4: Phương thức thanh toán có những gì?
        </button>
      </h2>
      <div id="collapseFour" class="accordion-collapse collapse" aria-labelledby="headingFour" data-bs-parent="#faqAccordion">
        <div class="accordion-body">
          Chúng tôi hỗ trợ nhiều phương thức thanh toán, bao gồm thẻ tín dụng, chuyển khoản ngân hàng và thanh toán khi nhận hàng.
        </div>
      </div>
    </div>
  </div>
</div>


  <!-- Tin công nghệ liên quan -->
  <div class="mt-5" id="tech-news">
    <h4 class="mb-3">Tin công nghệ</h4>
    <div class="card shadow-sm">
      <div class="card-body d-flex justify-content-between align-items-center">
        <div>
          <h5 class="card-title mb-1">Điện thoại cho người “cai" điện thoại</h5>
          <p class="card-text text-muted">Minimal Phone MP01 không dành cho tất cả mọi người, nhưng với những ai đang cảm thấy mệt mỏi vì …</p>
        </div>
        <a href="{% url 'tech_news' %}" class="btn btn-outline-primary">
          Xem tất cả &raquo;
        </a>
      </div>
    </div>
    <div class="card shadow-sm">
      <div class="card-body d-flex justify-content-between align-items-center">
        <div>
          <h5 class="card-title mb-1">Đồn đoán về mức giá của iPhone phiên bản</h5>
          <p class="card-text text-muted">HHT - iPhone Fold sẽ là chiếc điện thoại thông minh cực kỳ đắt tiền, khi một nguồn tin rò …</p>
        </div>
        <a href="{% url 'tech_news' %}" class="btn btn-outline-primary">
          Xem tất cả &raquo;
        </a>
      </div>
    </div>
  </div>
  </div>
  

{% block extra_css %}
<style>
  .star-rating {
    display: inline-block;
    direction: rtl;
  }

  .star-rating input[type="radio"] {
    display: none;
  }

  .star-rating label {
    color: #ddd;
    font-size: 2rem;
    cursor: pointer;
    transition: color 0.3s;
  }

  .star-rating input[type="radio"]:checked ~ label {
    color: gold;
  }

  .star-rating label:hover,
  .star-rating label:hover ~ label {
    color: gold;
  }
  
</style>
{% endblock %}
{% endblock %}
